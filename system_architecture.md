# RTSP-Web 系统架构图和数据流图

## 系统架构图

```
+----------------------------------+
|           客户端浏览器            |
+----------------------------------+
              |
              | HTTP/WebSocket
              v
+----------------------------------+
|           前端应用 (React)        |
+----------------------------------+
|                                  |
|  +----------------------------+  |
|  |        路由管理            |  |
|  |   (React Router)          |  |
|  +----------------------------+  |
|                                  |
|  +----------------------------+  |
|  |       播放器组件           |  |
|  |                           |  |
|  |  +---------------------+  |  |
|  |  |  JSMpeg Player      |  |  |
|  |  |  (低延迟播放)        |  |  |
|  |  +---------------------+  |  |
|  |                           |  |
|  |  +---------------------+  |  |
|  |  |  Flv.js Player 1    |  |  |
|  |  |  (WebSocket-FLV)    |  |  |
|  |  +---------------------+  |  |
|  |                           |  |
|  |  +---------------------+  |  |
|  |  |  Flv.js Player 2    |  |  |
|  |  |  (HTTP-FLV)         |  |  |
|  |  +---------------------+  |  |
|  |                           |  |
|  |  +---------------------+  |  |
|  |  |  HLS.js Player 1    |  |  |
|  |  |  (NodeMediaServer)  |  |  |
|  |  +---------------------+  |  |
|  |                           |  |
|  |  +---------------------+  |  |
|  |  |  HLS.js Player 2    |  |  |
|  |  |  (直接转换)          |  |  |
|  |  +---------------------+  |  |
|  |                           |  |
|  |  +---------------------+  |  |
|  |  |  监控视频面板        |  |  |
|  |  |  (集成所有播放器)    |  |  |
|  |  +---------------------+  |  |
|  +----------------------------+  |
|                                  |
+----------------------------------+
              |
              | HTTP/WebSocket
              v
+----------------------------------+
|           后端服务 (Node.js)      |
+----------------------------------+
|                                  |
|  +----------------------------+  |
|  |      Express 服务器        |  |
|  +----------------------------+  |
|                                  |
|  +----------------------------+  |
|  |      视频流转换服务        |  |
|  |                           |  |
|  |  +---------------------+  |  |
|  |  | RTSP → WebSocket    |  |  |
|  |  | (FLV格式)           |  |  |
|  |  | 端口: 9998          |  |  |
|  |  +---------------------+  |  |
|  |                           |  |
|  |  +---------------------+  |  |
|  |  | RTSP → WebSocket    |  |  |
|  |  | (JSMpeg格式)        |  |  |
|  |  | 端口: 9999          |  |  |
|  |  +---------------------+  |  |
|  |                           |  |
|  |  +---------------------+  |  |
|  |  | RTSP → RTMP         |  |  |
|  |  | 端口: 9997          |  |  |
|  |  +---------------------+  |  |
|  |                           |  |
|  |  +---------------------+  |  |
|  |  | RTMP → HLS          |  |  |
|  |  | 端口: 8099          |  |  |
|  |  +---------------------+  |  |
|  |                           |  |
|  |  +---------------------+  |  |
|  |  | RTSP → M3U8         |  |  |
|  |  | 端口: 3000          |  |  |
|  |  +---------------------+  |  |
|  +----------------------------+  |
|                                  |
|  +----------------------------+  |
|  |      功能服务              |  |
|  |                           |  |
|  |  +---------------------+  |  |
|  |  | 截图服务            |  |  |
|  |  | 端口: 3001          |  |  |
|  |  +---------------------+  |  |
|  |                           |  |
|  |  +---------------------+  |  |
|  |  | 录制服务            |  |  |
|  |  | 端口: 3001          |  |  |
|  |  +---------------------+  |  |
|  +----------------------------+  |
|                                  |
+----------------------------------+
              |
              | RTSP
              v
+----------------------------------+
|           RTSP 视频源            |
|      (rtsp://localhost:8554)     |
+----------------------------------+
```

## 数据流图

```
+----------------+     RTSP     +----------------+
|                |------------->|                |
|   RTSP 视频源   |              |   FFmpeg 转换   |
|                |              |                |
+----------------+              +----------------+
                                       |
                                       | 多种格式转换
                                       v
                               +----------------+
                               |                |
                               |  多协议流媒体服务 |
                               |                |
                               +----------------+
                                       |
                                       | 多种协议提供
                                       v
+----------------+     HTTP     +----------------+     WebSocket    +----------------+
|                |<------------|                |----------------->|                |
|   HLS 播放器    |              |  Express 服务器 |                 |  WebSocket 播放器|
|  (HLS.js)      |              |                |                 |  (JSMpeg/FLV.js)|
+----------------+              +----------------+                 +----------------+
                                       |
                                       | HTTP API
                                       v
                               +----------------+
                               |                |
                               |   功能服务      |
                               | (截图/录制)     |
                               |                |
                               +----------------+
```

## 详细数据流说明

1. **RTSP 视频源 → FFmpeg 转换**
   - RTSP 流 (rtsp://localhost:8554/mystream) 被 FFmpeg 接收

2. **FFmpeg 转换 → 多协议流媒体服务**
   - FFmpeg 将 RTSP 流转换为多种格式:
     - WebSocket-FLV (端口 9998)
     - WebSocket-JSMpeg (端口 9999)
     - RTMP (端口 9997)
     - HLS/M3U8 (端口 3000 和 8099)

3. **多协议流媒体服务 → 客户端播放器**
   - WebSocket-FLV 流被 Flv.js Player 1 消费
   - WebSocket-JSMpeg 流被 JSMpeg Player 消费
   - HTTP-FLV 流被 Flv.js Player 2 消费
   - HLS 流被 HLS.js Player 1 和 2 消费

4. **客户端 → 功能服务**
   - 客户端发送截图请求到截图服务 (端口 3001)
   - 客户端发送录制请求到录制服务 (端口 3001)

5. **功能服务 → 客户端**
   - 截图服务返回 JPEG 图像给客户端
   - 录制服务保存视频片段并通知客户端

## 端口使用说明

- **9997**: RTMP 服务器
- **9998**: RTSP 转 WebSocket (FLV)
- **9999**: RTSP 转 WebSocket (JSMpeg)
- **8099**: NodeMediaServer HTTP 服务 (HLS 和 HTTP-FLV)
- **3000**: M3U8 服务
- **3001**: 截图和录制服务
- **5173**: 前端开发服务器 (Vite)
